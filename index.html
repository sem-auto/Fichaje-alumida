<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Fichaje ALUMIDA</title>
<style>
  :root{--gap:10px;--btnH:40px;--btnFS:14px;--nameFS:14px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Arial,sans-serif;background:#edf1f5;color:#0f172a}
  .wrap{max-width:880px;margin:4px auto;padding:0 8px}
  h1{margin:4px 0 6px;text-align:center;font-size:18px;font-weight:800}
  .bar{position:fixed;left:50%;top:6px;transform:translateX(-50%);
       width:min(860px,94vw);background:#fff;border-radius:10px;
       box-shadow:0 8px 20px rgba(0,0,0,.15);
       padding:6px 10px;display:flex;align-items:center;justify-content:center;
       font-weight:700;font-size:14px;z-index:20}
  .msg-ok{color:#0f6b35}.msg-err{color:#a21919}.bar[hidden]{display:none}
  .spacer{height:38px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);
       padding:8px;display:flex;flex-direction:column;align-items:center}
  .name{font-weight:700;font-size:var(--nameFS);margin-bottom:6px;text-align:center}
  .btns{display:flex;gap:8px;width:100%;justify-content:center}
  .btn{position:relative;flex:1;min-width:90px;height:var(--btnH);border-radius:10px;color:#fff;font-weight:700;
       font-size:var(--btnFS);display:flex;align-items:center;justify-content:center;user-select:none;cursor:pointer;
       box-shadow:0 3px 8px rgba(0,0,0,.08)}
  .btn:active{transform:translateY(1px)}
  .in{background:linear-gradient(180deg,#168a40,#0f6b35)}
  .out{background:linear-gradient(180deg,#c43535,#a12626)}
  .btn[aria-busy="true"]::after{
    content:"Enviando…";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    border-radius:inherit;background:rgba(0,0,0,.22);color:#fff;font-weight:700;font-size:12px
  }
  .card{width:min(420px,94vw);background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:8px;margin:10px auto}
  .card h3{margin:0 0 4px;font-size:12px;font-weight:700;text-align:center}
  #sig{width:100%;height:160px;background:#fff;border:1.5px dashed #cbd5e1;border-radius:10px;touch-action:none}
  .actions{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .actions .b{padding:10px 14px;border:0;border-radius:10px;font-weight:800;cursor:pointer}
  .clear{background:#eef1f5;color:#111}
  .send{background:#1366ff;color:#fff}
</style>
</head>
<body>
<div id="bar" class="bar" hidden><span id="barMsg" class="msg-ok">Listo</span></div>
<div class="spacer" aria-hidden="true"></div>

<div class="wrap">
  <h1>Fichaje ALUMIDA</h1>

  <div id="grid" class="grid"></div>

  <section class="card">
    <h3>Firma</h3>
    <canvas id="sig"></canvas>
    <div class="actions">
      <button class="b clear" id="btnClear">Borrar</button>
      <button class="b send"  id="btnEnviar">Enviar</button>
    </div>
  </section>
</div>

<iframe id="hiddenFrame" name="hiddenFrame" style="display:none"></iframe>
<audio id="beepAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const ENDPOINT="https://script.google.com/macros/s/AKfycbw9E5F2hLdS5VSv_xO1bJKL4PoxyizAukJiR8UmMaPKwN4PyWjJ6SmOgatSwVYiKwF-/exec";
const WORKERS=["Salvador Sanchez Bonet","Mari Paz Garcia Saez"];

const grid=document.getElementById('grid');
const bar=document.getElementById('bar'), barMsg=document.getElementById('barMsg');
const hiddenFrame=document.getElementById('hiddenFrame');
const beepTag=document.getElementById('beepAudio');

let nombre=null,tipo=null,sending=false;
function setBar(msg,ok=true){barMsg.textContent=msg;barMsg.className=ok?'msg-ok':'msg-err';bar.hidden=false;}
function beepOk(){try{beepTag.currentTime=0;beepTag.play().catch(()=>{});}catch{}}

WORKERS.forEach(N=>{
  const row=document.createElement('div');row.className='row';
  const name=document.createElement('div');name.className='name';name.textContent=N;
  const btns=document.createElement('div');btns.className='btns';
  const bIn=document.createElement('div');bIn.className='btn in';bIn.textContent='Entrada';
  const bOut=document.createElement('div');bOut.className='btn out';bOut.textContent='Salida';
  bIn.onclick=()=>pick(N,'entrada',bIn);
  bOut.onclick=()=>pick(N,'salida',bOut);
  btns.appendChild(bIn);btns.appendChild(bOut);
  row.appendChild(name);row.appendChild(btns);
  grid.appendChild(row);
});

function pick(n,t,btn){
  if(sending) return;
  nombre=n; tipo=t;
  setBar(`Seleccionado: ${n} · ${t.toUpperCase()}. Firma y pulsa Enviar.`,true);
}

const sig=document.getElementById('sig');
const ctx=sig.getContext('2d',{willReadFrequently:true});
let drawing=false, hasStroke=false, last={x:0,y:0};

function paintWhite(){
  ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle="#fff";
  ctx.fillRect(0,0,sig.width,sig.height); ctx.restore();
}
function fit(){
  const r=Math.max(devicePixelRatio||1,1);
  const w=sig.clientWidth||400, h=sig.clientHeight||160;
  sig.width=Math.round(w*r); sig.height=Math.round(h*r);
  ctx.setTransform(r,0,0,r,0,0); paintWhite();
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=3.2; ctx.strokeStyle='#000';
}
fit();
addEventListener('resize',()=>{const img=sig.toDataURL('image/png'); fit(); const im=new Image(); im.onload=()=>ctx.drawImage(im,0,0,sig.clientWidth,sig.clientHeight); im.src=img;});
function pos(e){const r=sig.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};}
function start(e){drawing=true; last=pos(e); e.preventDefault();}
function move(e){if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; hasStroke=true; e.preventDefault();}
function end(){drawing=false;}
sig.addEventListener('mousedown',start); sig.addEventListener('mousemove',move); addEventListener('mouseup',end);
sig.addEventListener('touchstart',start,{passive:false}); sig.addEventListener('touchmove',move,{passive:false}); sig.addEventListener('touchend',end);

document.getElementById('btnClear').onclick=()=>{ paintWhite(); hasStroke=false; setBar('Firma borrada.',true); };

document.getElementById('btnEnviar').onclick=async()=>{
  if(sending) return;
  if(!nombre||!tipo){ setBar('Selecciona trabajador y tipo.',false); return; }
  if(!hasStroke){ setBar('Firma requerida.',false); return; }
  sending=true; setBar('Enviando…',true);
  try{
    // fondo blanco bajo trazo
    ctx.save(); ctx.globalCompositeOperation='destination-over'; ctx.fillStyle='#fff'; ctx.fillRect(0,0,sig.width,sig.height); ctx.restore();

    const dataURL = sig.toDataURL('image/png'); // firma base64
    const txId = 'tx_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);

    // POST firma (JSON) y GET fichaje en paralelo
    const payload = JSON.stringify({ nombre, tipo, firma: dataURL, txId });
    fetch(ENDPOINT,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:payload }).catch(()=>{});
    hiddenFrame.src = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&t=${Date.now()}`;

    setTimeout(()=>{ beepOk(); setBar(`OK ${nombre} — ${tipo.toUpperCase()} · ${new Date().toLocaleTimeString('es-ES')}`, true); paintWhite(); hasStroke=false; sending=false; }, 1200);
  }catch(_){
    setBar('Error de red', false); sending=false;
  }
};
</script>
</body>
</html>
